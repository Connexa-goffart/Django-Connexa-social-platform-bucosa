{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <meta name="theme-color" content="#22223b" />

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js"></script>

  <script src="{% static 'js/theme-toggle.js' %}"></script>
  <script src="{% static 'js/pwa-install.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>
  <script src="{% static 'js/firebase-push.js' %}" defer></script>

  <script>
    window.USER_IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
  </script>

  {% block extra_head %}{% endblock %}

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register("{% static 'service-worker.js' %}")
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>

  <style>
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin-slow {
      animation: spin-slow 3s linear infinite;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen transition-colors duration-300" id="body-root">

  <!-- Futuristic Link Click Loader -->
  <div id="circle-loader" class="fixed inset-0 bg-white bg-opacity-100 flex items-center justify-center z-[9999] hidden">
    <div class="relative w-24 h-24">
      <div class="absolute inset-0 rounded-full border-[6px] border-blue-500 animate-pulse blur-sm opacity-50"></div>
      <div class="absolute inset-2 rounded-full border-[3px] border-blue-500 animate-spin-slow"></div>
      <div class="absolute inset-4 rounded-full border-[2px] border-blue-300 animate-ping"></div>
      <div class="absolute w-4 h-4 bg-blue-600 rounded-full top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-pulse"></div>
    </div>
  </div>

  <!-- Install PWA Button -->
  <button id="pwa-install-btn" style="display:none;position:fixed;bottom:100px;right:24px;z-index:1000;background:#1976d2;color:#fff;padding:12px 24px;border:none;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:16px;cursor:pointer;">
    Install Bucosa App
  </button>

  <!-- Desktop Sidebar -->
  <nav id="desktopSidebar" class="desktop-sidebar">
    ... <!-- Keep your existing sidebar nav content here -->
  </nav>

  <!-- Mobile Nav -->
  <nav id="mobileNav" class="mobile-nav">
    <div class="nav-expanded" id="expandedMenu">
      ... <!-- Keep your existing expanded menu here -->
    </div>

    <div class="nav-main-container flex justify-between px-2 py-1 bg-white shadow-inner border-t border-gray-200">
      <a href="{% url 'activities:home' %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %} flex-1 text-center" data-page="home">
        <div class="nav-item-content">
          <span class="material-icons nav-icon">home</span>
          <span class="nav-label text-xs">Home</span>
        </div>
      </a>

      <a href="{% url 'users:profile' user.id %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %} flex-1 text-center" data-page="profile">
        <div class="nav-item-content">
          <span class="material-icons nav-icon">person_outline</span>
          <span class="nav-label text-xs">Profile</span>
        </div>
      </a>

      <a href="#" class="nav-item nav-more-btn flex-1 text-center" id="moreButton">
        <div class="nav-item-content">
          <span class="material-icons nav-icon">add</span>
          <span class="nav-label text-xs">More</span>
        </div>
        <div class="more-btn-bg"></div>
      </a>

      <a href="{% url 'users:private_messages' %}" class="nav-item nav-link {% if request.resolver_match.url_name == 'private_messages' %}active{% endif %} flex-1 text-center" data-page="messages">
        <div class="nav-item-content">
          <span class="material-icons nav-icon">chat_bubble_outline</span>
          <span class="nav-label text-xs">Messages</span>
        </div>
      </a>

      <a href="#" class="nav-item flex-1 text-center" id="mobile-notifications">
        <div class="nav-item-content relative">
          <span class="material-icons nav-icon">notifications_none</span>
          <span class="nav-label text-xs">Notifications</span>
          <span id="mobile-notification-badge" class="notification-badge absolute top-0 right-1 bg-red-600 text-white text-xs px-1.5 rounded-full" style="display:none;">0</span>
        </div>
      </a>
    </div>
  </nav>

  <!-- Page Content -->
  <main class="main-content">
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
      {% block content %}
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Welcome to Bucosa</h1>
      <p class="text-gray-600">Your content goes here...</p>
      {% endblock %}
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const moreButton = document.getElementById('moreButton');
      const expandedMenu = document.getElementById('expandedMenu');
      let isExpanded = false;

      // More menu toggle
      moreButton.addEventListener('click', function (e) {
        e.preventDefault();
        isExpanded = !isExpanded;
        expandedMenu.classList.toggle('show', isExpanded);
        moreButton.classList.toggle('active', isExpanded);
      });

      // Outside click to close
      document.addEventListener('click', function (e) {
        if (!e.target.closest('#mobileNav') && isExpanded) {
          expandedMenu.classList.remove('show');
          moreButton.classList.remove('active');
          isExpanded = false;
        }
      });

      // Close on nav item click
      document.querySelectorAll('.nav-expanded-item').forEach(item => {
        item.addEventListener('click', function () {
          if (!this.id.includes('notifications')) {
            expandedMenu.classList.remove('show');
            moreButton.classList.remove('active');
            isExpanded = false;
          }
        });
      });

      // Notifications
      document.getElementById('mobile-notifications')?.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Mobile notifications clicked');
      });

      document.getElementById('desktop-notifications')?.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Desktop notifications clicked');
      });

      // Escape to close
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && isExpanded) {
          expandedMenu.classList.remove('show');
          moreButton.classList.remove('active');
          isExpanded = false;
        }
      });

      // Futuristic loader trigger
      const circleLoader = document.getElementById('circle-loader');
      document.querySelectorAll('a[href]:not([href^="#"])').forEach(link => {
        link.addEventListener('click', e => {
          const target = e.currentTarget.getAttribute('target');
          if (!e.ctrlKey && !e.metaKey && target !== '_blank') {
            circleLoader.classList.remove('hidden');
          }
        });
      });

      // Add animation for expanded menu
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideUp {
          from { transform: translateY(20px) scale(0.95); opacity: 0; }
          to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .nav-expanded.show {
          animation: slideUp 0.3s ease-out;
        }
      `;
      document.head.appendChild(style);
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
