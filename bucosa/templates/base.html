{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <meta name="theme-color" content="#22223b" />

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js"></script>

  <script src="{% static 'js/theme-toggle.js' %}"></script>
  <script src="{% static 'js/pwa-install.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>

  <script>
    window.USER_IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
  </script>
  <script src="{% static 'js/firebase-push.js' %}" defer></script>

  {% block extra_head %}{% endblock %}

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register("{% static 'service-worker.js' %}")
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>

</head>
<body class="bg-gray-50 min-h-screen transition-colors duration-300" id="body-root">

  <!-- Initial Page Loader -->
  <div id="page-loader" class="page-loader">
    <div class="loader-container">
      <div class="loader-spinner"></div>
      <div class="loader-text">Loading Bucosa...</div>
    </div>
  </div>

  <!-- Navigation Loading Bar -->
  <div id="nav-loading-bar" class="nav-loading-bar"></div>

  <!-- Bubble Loading Animation -->
  <div class="bubble-loading" id="bubbleLoading">
    <div class="bubble"></div>
    <div class="bubble-text" id="bubbleText">Loading content...</div>
  </div>

  <!-- Modern Loading Transition -->
  <div class="page-transition" id="pageTransition">
    <div class="loading-animation">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="loading-text" id="loadingText">Loading content...</div>
  </div>

  <!-- PWA Install Button -->
  <button id="pwa-install-btn" style="display:none;position:fixed;bottom:100px;right:24px;z-index:1000;background:#1976d2;color:#fff;padding:12px 24px;border:none;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:16px;cursor:pointer;">
    Install Bucosa App
  </button>

  <!-- Desktop Home Button (bigger more.png) -->
  <a href="{% url 'activities:home' %}" class="desktop-home-btn hidden md:flex" data-page="home">
    <img src="{% static 'img/more.png' %}" alt="Home" />
  </a>

  <!-- Desktop Sidebar -->
  <nav id="desktopSidebar" class="desktop-sidebar hidden md:flex md:flex-col bg-gradient-to-b from-indigo-900 to-purple-900 text-white shadow-xl">
    <div class="sidebar-header p-6 pb-4 flex items-center justify-between border-b border-white/10">
      <div class="sidebar-logo flex items-center space-x-3">
        <img src="{% static 'img/bucosa-logo.png' %}" alt="Bucosa Logo" class="w-8 h-8 object-contain">
        <h2 class="text-xl font-bold">Bucosa</h2>
      </div>
    </div>
    
    <div class="sidebar-nav flex-1 overflow-y-auto py-4 px-2">
      <div class="nav-section space-y-1">
        <a href="{% url 'users:search_users' %}" class="sidebar-item nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10 {% if request.resolver_match.url_name == 'search_users' %}bg-white/10 border-l-4 border-white{% endif %}" data-page="search">
          <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">search</span>
          <span class="nav-label font-medium">Search</span>
        </a>
        
        <a href="{% url 'users:private_messages' %}" class="sidebar-item nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10 {% if request.resolver_match.url_name == 'private_messages' %}bg-white/10 border-l-4 border-white{% endif %}" data-page="messages">
          <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">chat_bubble_outline</span>
          <span class="nav-label font-medium">Messages</span>
        </a>
        
        <a href="#" class="sidebar-item group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10" id="desktop-notifications">
          <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">notifications_none</span>
          <span class="nav-label font-medium">Notifications</span>
          <span id="desktop-notification-badge" class="notification-badge ml-auto bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </a>
        
        <a href="{% url 'users:profile' user.id %}" class="sidebar-item nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10 {% if request.resolver_match.url_name == 'profile' %}bg-white/10 border-l-4 border-white{% endif %}" data-page="profile">
          <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">person_outline</span>
          <span class="nav-label font-medium">Profile</span>
        </a>
      </div>
      
      <div class="sidebar-section mt-8">
        <div class="sidebar-section-title flex items-center px-4 py-2 text-white/60 text-sm font-semibold uppercase tracking-wider">
          <span class="material-icons section-icon mr-2 text-base">groups</span>
          Community
        </div>
        
        <a href="{% url 'fellowship_detail' 1 %}" class="sidebar-item nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10 {% if request.resolver_match.url_name == 'fellowship_detail' %}bg-white/10 border-l-4 border-white{% endif %}" data-page="fellowship">
          <span class="material-symbols-outlined nav-icon mr-3 text-white/80 group-hover:text-white">church</span>
          <span class="nav-label font-medium">Fellowship</span>
        </a>
        
        <a href="{% url 'bucosa_main' %}" class="sidebar-item nav-link group flex items-center px-4 py-3 rounded-lg transition-all duration-200 hover:bg-white/10" data-page="bucosa-main">
          <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">groups</span>
          <span class="nav-label font-medium">Bucosa Main</span>
        </a>
      </div>
    </div>

    <div class="sidebar-footer p-4 border-t border-white/10">
      <a href="{% url 'users:logout' %}" class="sidebar-item logout-item group flex items-center px-4 py-2 rounded-lg transition-all duration-200 hover:bg-white/10">
        <span class="material-icons nav-icon mr-3 text-white/80 group-hover:text-white">logout</span>
        <span class="nav-label font-medium">Logout</span>
      </a>
    </div>
  </nav>

  <!-- Mobile Bottom Navigation -->
  <nav id="mobileNav" class="mobile-nav md:hidden">
    <!-- Expanded Menu -->
    <div class="nav-expanded" id="expandedMenu">
      <div class="expanded-header">
        <div class="expanded-logo">
          <img src="{% static 'img/bucosa-logo.png' %}" alt="Bucosa Logo">
          <h2>Bucosa</h2>
        </div>
        <button class="close-expanded" id="closeExpanded">
          <span class="material-icons text-gray-600">close</span>
        </button>
      </div>
      
      <div class="expanded-user-info">
        <div class="user-avatar">
          <img src="{{ request.user.profile.avatar.url|default:'/static/img/default-avatar.png' }}" alt="Profile">
        </div>
        <div class="user-details">
          <h3>{{ request.user.get_full_name|default:request.user.username }}</h3>
          <p>@{{ request.user.username }}</p>
        </div>
      </div>
      
      <div class="nav-expanded-grid">
        <a href="{% url 'users:search_users' %}" class="nav-expanded-item {% if request.resolver_match.url_name == 'search_users' %}active{% endif %}" data-page="search">
          <span class="material-icons">search</span>
          <span>Search</span>
        </a>

        <a href="{% url 'fellowship_detail' 1 %}" class="nav-expanded-item {% if request.resolver_match.url_name == 'fellowship_detail' %}active{% endif %}" data-page="fellowship">
          <span class="material-symbols-outlined">church</span>
          <span>Fellowship</span>
        </a>
        
        <a href="{% url 'bucosa_main' %}" class="nav-expanded-item" data-page="bucosa-main">
          <span class="material-icons">groups</span>
          <span>Bucosa</span>
        </a>
        
        <a href="{% url 'users:user_settings' %}" class="nav-expanded-item" data-page="settings">
          <span class="material-icons">settings</span>
          <span>Settings</span>
        </a>
        
        <a href="#" class="nav-expanded-item" id="expanded-notifications">
          <span class="material-icons">notifications_none</span>
          <span>Notifications</span>
        </a>
        
        <a href="{% url 'users:logout' %}" class="nav-expanded-item">
          <span class="material-icons">logout</span>
          <span>Logout</span>
        </a>
      </div>
    </div>

    <!-- Main Bottom Navigation -->
    <div class="nav-main-container">
      <a href="{% url 'activities:home' %}" class="nav-item {% if request.resolver_match.url_name == 'home' %}active{% endif %}" data-page="home">
        <span class="material-icons">home</span>
        <span class="text-xs">Home</span>
      </a>
      
      <a href="{% url 'users:profile' user.id %}" class="nav-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" data-page="profile">
        <span class="material-icons">person_outline</span>
        <span class="text-xs">Profile</span>
      </a>

      <button class="nav-more-btn" id="moreButton">
        <div class="more-btn-bg"></div>
        <img src="{% static 'img/more.png' %}" alt="Menu">
      </button>

      <a href="{% url 'users:private_messages' %}" class="nav-item {% if request.resolver_match.url_name == 'private_messages' %}active{% endif %}" data-page="messages">
        <span class="material-icons">chat_bubble_outline</span>
        <span class="text-xs">Messages</span>
      </a>

      <a href="#" class="nav-item relative" id="mobile-notifications">
        <span class="material-icons">notifications_none</span>
        <span class="text-xs">Notifications</span>
        <span id="mobile-notification-badge" class="notification-badge hidden">0</span>
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
      {% block content %}
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Welcome to Bucosa</h1>
      <p class="text-gray-600">Your content goes here...</p>
      {% endblock %}
    </div>
  </main>

  <script>
    // Page Transition Logic
    document.addEventListener('DOMContentLoaded', function() {
      // Hide initial page loader
      const pageLoader = document.getElementById('page-loader');
      setTimeout(() => {
        pageLoader.classList.add('hidden');
      }, 500);

      // Get transition elements
      const pageTransition = document.getElementById('pageTransition');
      const bubbleLoading = document.getElementById('bubbleLoading');
      const bubbleText = document.getElementById('bubbleText');
      const loadingText = document.getElementById('loadingText');
      const navLoadingBar = document.getElementById('nav-loading-bar');
      
      // Function to start loading with bubble animation
      function startLoading(destination) {
        bubbleLoading.classList.add('active');
        navLoadingBar.classList.add('active');
        
        const pageName = getPageName(destination);
        bubbleText.textContent = `Loading ${pageName}...`;
      }
      
      // Function to stop loading
      function stopLoading() {
        pageTransition.classList.remove('active');
        bubbleLoading.classList.remove('active');
        navLoadingBar.classList.remove('active');
      }
      
      // Helper function to get page name from URL
      function getPageName(url) {
        const path = new URL(url, window.location.origin).pathname;
        if (path.includes('profile')) return 'Profile';
        if (path.includes('messages')) return 'Messages';
        if (path.includes('search')) return 'Search';
        if (path.includes('fellowship')) return 'Fellowship';
        if (path.includes('bucosa-main')) return 'Bucosa';
        if (path.includes('home')) return 'Home';
        return 'page';
      }
      
      // Intercept all link clicks
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        
        if (link && link.href && !link.href.includes('#') && 
            !link.classList.contains('no-transition') &&
            new URL(link.href).origin === window.location.origin) {
          e.preventDefault();
          startLoading(link.href);
          
          // Navigate after a short delay to allow animation to show
          setTimeout(() => {
            window.location.href = link.href;
          }, 1500);
        }
      });
      
      // When page is fully loaded
      window.addEventListener('load', function() {
        // Hide loading transition with a slight delay
        setTimeout(stopLoading, 300);
      });
      
      // Also hide loading if there's an error
      window.addEventListener('error', stopLoading);

      // Mobile nav toggle logic
      const moreButton = document.getElementById('moreButton');
      const expandedMenu = document.getElementById('expandedMenu');
      const closeExpanded = document.getElementById('closeExpanded');
      let isExpanded = false;

      // Toggle expanded menu
      function toggleExpandedMenu() {
        isExpanded = !isExpanded;
        
        if (isExpanded) {
          expandedMenu.classList.add('show');
          moreButton.classList.add('active');
          document.body.style.overflow = 'hidden';
        } else {
          expandedMenu.classList.remove('show');
          moreButton.classList.remove('active');
          document.body.style.overflow = '';
        }
      }

      // More button click handler
      moreButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleExpandedMenu();
      });

      // Close button handler
      closeExpanded.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleExpandedMenu();
      });

      // Close expanded menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#mobileNav') && isExpanded) {
          toggleExpandedMenu();
        }
      });

      // Handle escape key to close expanded menu
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isExpanded) {
          toggleExpandedMenu();
        }
      });

      // Notification handling
      function updateNotificationBadges(count) {
        const badges = document.querySelectorAll('[id$="notification-badge"]');
        badges.forEach(badge => {
          if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        });
      }

      // Handle notification clicks
      document.getElementById('mobile-notifications')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Mobile notifications clicked');
        // Add your notification logic here
      });

      document.getElementById('desktop-notifications')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Desktop notifications clicked');
        // Add your notification logic here
      });

      document.getElementById('expanded-notifications')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Expanded notifications clicked');
        // Add your notification logic here
        if (isExpanded) {
          toggleExpandedMenu();
        }
      });

      // Example: Update notification count (uncomment to test)
      // updateNotificationBadges(3);

      // Handle expanded menu item clicks
      const expandedItems = document.querySelectorAll('.nav-expanded-item');
      expandedItems.forEach(item => {
        item.addEventListener('click', function(e) {
          // Close expanded menu when navigating
          if (isExpanded && !this.href.includes('#')) {
            setTimeout(() => {
              toggleExpandedMenu();
            }, 100);
          }
        });
      });

      // Smooth scroll for anchor links
      const anchorLinks = document.querySelectorAll('a[href^="#"]');
      anchorLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          const targetId = this.getAttribute('href');
          const targetElement = document.querySelector(targetId);
          
          if (targetElement) {
            e.preventDefault();
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });

      // Add active states for current page
      const currentPath = window.location.pathname;
      const navLinks = document.querySelectorAll('.nav-link, .nav-item, .nav-expanded-item');
      
      navLinks.forEach(link => {
        if (link.href && new URL(link.href).pathname === currentPath) {
          link.classList.add('active');
        }
      });

      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024 && isExpanded) {
          // Close mobile menu if switching to desktop
          toggleExpandedMenu();
        }
      });

      // Prevent background scroll when menu is open
      function preventScroll(e) {
        if (isExpanded) {
          e.preventDefault();
        }
      }

      // Add touch events for better mobile experience
      document.addEventListener('touchmove', preventScroll, { passive: false });

      // Initialize tooltips or other UI enhancements
      function initializeUI() {
        // Add any additional UI initialization here
        console.log('Bucosa UI initialized');
      }

      // Run UI initialization
      initializeUI();
    });

    // Service Worker registration and PWA functionality
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful');
        })
        .catch(function(err) {
          console.log('ServiceWorker registration failed');
        });
    }

    // PWA Install prompt
    let deferredPrompt;
    const installButton = document.getElementById('pwa-install-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        deferredPrompt = null;
        installButton.style.display = 'none';
      }
    });

    // Handle app install
    window.addEventListener('appinstalled', (evt) => {
      console.log('App installed');
      installButton.style.display = 'none';
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>