{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <meta name="theme-color" content="#22223b" />

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js"></script>

  <!-- Global Scripts -->
  <script src="{% static 'js/theme-toggle.js' %}"></script>
  <script src="{% static 'js/pwa-install.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>

  <!-- Auth flag for JS -->
  <script>
    window.USER_IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
  </script>
  <script src="{% static 'js/firebase-push.js' %}" defer></script>

  {% block extra_head %}{% endblock %}

  <!-- Register one service worker only -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register("{% static 'service-worker.js' %}")
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>

</head>
<body class="bg-white min-h-screen transition-colors duration-300 text-black" id="body-root">

  <!-- PWA Install Button -->
  <button id="pwa-install-btn" style="display:none;position:fixed;bottom:100px;right:24px;z-index:1000;background:#1976d2;color:#fff;padding:12px 24px;border:none;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:16px;cursor:pointer;">
    Install Bucosa App
  </button>

  <!-- Main Content -->
  <main class="main-content">
    <div class="rounded-xl p-6 transition-colors duration-300 shadow">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Unified Responsive Navigation Bar -->
  <nav id="mainNav">
    <ul class="nav nav-pills nav-links-container">
      <!-- Primary visible links on mobile -->
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'activities:home' %}" data-link-id="home">
          <span class="material-icons">home</span>
          <span class="nav-text hidden md:inline">Home</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'search_users' %}active{% endif %}" href="{% url 'users:search_users' %}" data-link-id="explore">
          <span class="material-icons">explore</span>
          <span class="nav-text hidden md:inline">Explore</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if request.resolver_match.url_name == 'private_messages' %}active{% endif %}" href="{% url 'users:private_messages' %}" data-link-id="messages">
          <span class="material-icons">mail</span>
          <span class="nav-text hidden md:inline">Messages</span>
        </a>
      </li>
      
      <!-- Toggle button (leaf icon) - only visible on mobile -->
      <li class="nav-item md:hidden">
        <a class="nav-link toggle-button" href="#" id="toggleLeaf">
          <i class="fas fa-ellipsis-h"></i>
        </a>
      </li>

      <!-- Hidden links on mobile, always visible on desktop -->
      <li class="nav-item hidden-mobile-link">
        <a class="nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" href="{% url 'users:profile' user.id %}" data-link-id="profile">
          <span class="material-icons">person</span>
          <span class="nav-text hidden md:inline">Profile</span>
        </a>
      </li>
      <li class="nav-item hidden-mobile-link">
        <a class="nav-link {% if request.resolver_match.url_name == 'fellowship_detail' %}active{% endif %}" href="{% url 'fellowship_detail' 1 %}" data-link-id="fellowship">
          <span class="material-symbols-outlined">church</span>
          <span class="nav-text hidden md:inline">Fellowship</span>
        </a>
      </li>
      <li class="nav-item hidden-mobile-link">
        <a class="nav-link" href="{% url 'bucosa_main' %}" data-link-id="bucosa">
          <span class="material-icons">groups</span>
          <span class="nav-text hidden md:inline">Bucosa</span>
        </a>
      </li>
      <li class="nav-item hidden-mobile-link" id="notification-nav-item">
        <a class="nav-link" href="#" data-link-id="notifications" id="notificationDropdown">
          <span class="material-icons">notifications</span>
          <span class="nav-text hidden md:inline">Notifications</span>
          <span id="notification-badge" class="notification-badge" style="display:none;">0</span>
        </a>
        <div id="notification-dropdown" style="display:none;position:absolute;left:60px;top:0;background:#fff;border:1px solid #ccc;width:300px;max-height:400px;overflow-y:auto;z-index:1000;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
      </li>
      <li class="nav-item hidden-mobile-link">
        <a class="nav-link" href="{% url 'users:logout' %}" data-link-id="logout">
          <span class="material-icons">logout</span>
          <span class="nav-text hidden md:inline">Logout</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- JavaScript for Navigation -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mainNav = document.getElementById('mainNav');
      const navLinks = document.querySelectorAll('#mainNav .nav-link');
      const toggleLeaf = document.getElementById('toggleLeaf');

      // Function to check if it's a mobile view
      function isMobileView() {
        return window.matchMedia("(max-width: 767.98px)").matches;
      }

      // Function to set the active link based on current URL
      function setActiveLinkBasedOnUrl() {
        const currentPath = window.location.pathname;
        navLinks.forEach(link => {
          if (link !== toggleLeaf) {
            const href = link.getAttribute('href');
            if (href && currentPath === href) {
              link.classList.add('active');
            } else {
              link.classList.remove('active');
            }
          }
        });
      }

      // Set initial active link
      setActiveLinkBasedOnUrl();

      // Handle clicks on regular navigation links (excluding the toggle)
      navLinks.forEach(link => {
        if (link !== toggleLeaf && !link.closest('#notification-nav-item')) {
          link.addEventListener('click', function(event) {
            // Don't prevent default for actual navigation links
            
            // Remove 'active' class from all links except toggle
            navLinks.forEach(l => {
              if (l !== toggleLeaf) {
                l.classList.remove('active');
              }
            });

            // Add 'active' class to the clicked link
            this.classList.add('active');

            // If in mobile view and hidden links are shown, hide them
            if (isMobileView() && mainNav.classList.contains('show-all-links')) {
              setTimeout(() => {
                mainNav.classList.remove('show-all-links');
                toggleLeaf.classList.remove('active');
              }, 200);
            }
          });
        }
      });

      // Handle click on the toggle button
      if (toggleLeaf) {
        toggleLeaf.addEventListener('click', function(event) {
          event.preventDefault();
          if (isMobileView()) {
            mainNav.classList.toggle('show-all-links');
            this.classList.toggle('active');
          }
        });
      }

      // Handle window resize
      window.addEventListener('resize', function() {
        if (!isMobileView()) {
          mainNav.classList.remove('show-all-links');
          if (toggleLeaf) {
            toggleLeaf.classList.remove('active');
          }
        }
      });

      // Notification handling
      const notificationDropdown = document.getElementById('notificationDropdown');
      const notificationDropdownMenu = document.getElementById('notification-dropdown');

      if (notificationDropdown && notificationDropdownMenu) {
        notificationDropdown.addEventListener('click', function(event) {
          event.preventDefault();
          const isVisible = notificationDropdownMenu.style.display === 'block';
          notificationDropdownMenu.style.display = isVisible ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
          if (!event.target.closest('#notification-nav-item')) {
            notificationDropdownMenu.style.display = 'none';
          }
        });
      }

      // Function to update notification badges
      function updateNotificationBadges(count) {
        const badge = document.getElementById('notification-badge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      // Example: updateNotificationBadges(3);
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>