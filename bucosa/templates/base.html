{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <meta name="theme-color" content="#22223b" />

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js"></script>

  <script src="{% static 'js/theme-toggle.js' %}"></script>
  <script src="{% static 'js/pwa-install.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>

  <script>
    window.USER_IS_AUTHENTICATED = {{ request.user.is_authenticated|yesno:"true,false" }};
  </script>
  <script src="{% static 'js/firebase-push.js' %}" defer></script>

  {% block extra_head %}{% endblock %}

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register("{% static 'service-worker.js' %}")
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.error("SW registration failed:", err));
      });
    }
  </script>

</head>
<body class="bg-gray-50 min-h-screen transition-colors duration-300" id="body-root">

  <!-- Initial Page Loader -->
  <div id="page-loader" class="page-loader">
    <div class="loader-container">
      <div class="loader-spinner"></div>
      <div class="loader-text">Loading Bucosa...</div>
    </div>
  </div>

  <!-- Navigation Loading Bar -->
  <div id="nav-loading-bar" class="nav-loading-bar"></div>

  <!-- Modern Loading Transition -->
  <div class="page-transition" id="pageTransition">
    <div class="loading-animation">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="loading-text" id="loadingText">Loading content...</div>
  </div>

  <button id="pwa-install-btn" style="display:none;position:fixed;bottom:100px;right:24px;z-index:1000;background:#1976d2;color:#fff;padding:12px 24px;border:none;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:16px;cursor:pointer;">
    Install Bucosa App
  </button>

  <nav id="desktopSidebar" class="desktop-sidebar">
  <div class="sidebar-header">
      <div class="sidebar-logo">
        <h1>Bucosa</h1>
        <div class="logo-accent"></div>
      </div>
    </div>
    
    <div class="sidebar-nav">
      <div class="nav-section">
        <a href="{% url 'activities:home' %}" class="sidebar-item nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" data-page="home">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">home</span>
            <span class="nav-label">Home</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
        <a href="{% url 'users:search_users' %}" class="sidebar-item nav-link {% if request.resolver_match.url_name == 'search_users' %}active{% endif %}" data-page="search">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">search</span>
            <span class="nav-label">Search</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
        <a href="{% url 'users:private_messages' %}" class="sidebar-item nav-link {% if request.resolver_match.url_name == 'private_messages' %}active{% endif %}" data-page="messages">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">chat_bubble_outline</span>
            <span class="nav-label">Messages</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
        <a href="#" class="sidebar-item" id="desktop-notifications">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">notifications_none</span>
            <span class="nav-label">Notifications</span>
            <span id="desktop-notification-badge" class="notification-badge" style="display:none;">0</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
        <a href="{% url 'users:profile' user.id %}" class="sidebar-item nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" data-page="profile">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">person_outline</span>
            <span class="nav-label">Profile</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-section-title">
          <span class="material-icons section-icon">groups</span>
          Community
        </div>
        <a href="{% url 'fellowship_detail' 1 %}" class="sidebar-item nav-link {% if request.resolver_match.url_name == 'fellowship_detail' %}active{% endif %}" data-page="fellowship">
          <div class="nav-item-content">
            <span class="material-symbols-outlined nav-icon">church</span>
            <span class="nav-label">Fellowship</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
        <a href="{% url 'bucosa_main' %}" class="sidebar-item nav-link" data-page="bucosa-main">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">groups</span>
            <span class="nav-label">Bucosa Main</span>
          </div>
          <div class="nav-item-indicator"></div>
        </a>
      </div>

      <div class="sidebar-footer">
        <a href="{% url 'users:logout' %}" class="sidebar-item logout-item">
          <div class="nav-item-content">
            <span class="material-icons nav-icon">logout</span>
            <span class="nav-label">Logout</span>
          </div>
        </a>
      </div>
    </div>
  </nav>
    <!-- Replace your existing mobile nav section with this improved version -->
  <nav id="mobileNav" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl px-5 py-3 z-50 border-t border-gray-100">
    
    <!-- Expanded Menu (hidden by default) -->
    <div class="nav-expanded absolute bottom-full left-0 right-0 bg-white rounded-2xl shadow-xl mx-4 mb-3 p-5 border border-gray-100" id="expandedMenu">
      <div class="flex justify-end mb-4">
        <button class="p-2 hover:bg-gray-100 rounded-full transition-colors" id="closeExpanded">
          <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="grid grid-cols-3 gap-4">
        <!-- Search -->
        <a href="{% url 'users:search_users' %}" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors {% if request.resolver_match.url_name == 'search_users' %}bg-indigo-50 text-indigo-600{% endif %}">
          <span class="material-icons text-2xl mb-2">search</span>
          <span class="text-xs font-medium">Search</span>
        </a>
        
        <!-- Fellowship -->
        <a href="{% url 'fellowship_detail' 1 %}" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors {% if request.resolver_match.url_name == 'fellowship_detail' %}bg-indigo-50 text-indigo-600{% endif %}">
          <span class="material-symbols-outlined text-2xl mb-2">church</span>
          <span class="text-xs font-medium">Fellowship</span>
        </a>
        
        <!-- Bucosa -->
        <a href="{% url 'bucosa_main' %}" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors">
          <span class="material-icons text-2xl mb-2">groups</span>
          <span class="text-xs font-medium">Bucosa</span>
        </a>
        
        <!-- Settings -->
        <a href="{% url 'users:user_settings' %}" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors">
          <span class="material-icons text-2xl mb-2">settings</span>
          <span class="text-xs font-medium">Settings</span>
        </a>
        
        <!-- Help or Additional Feature -->
        <a href="#" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-indigo-50 text-gray-600 hover:text-indigo-600 transition-colors">
          <span class="material-icons text-2xl mb-2">help</span>
          <span class="text-xs font-medium">Help</span>
        </a>
        
        <!-- Logout -->
        <a href="{% url 'users:logout' %}" class="nav-hover-effect flex flex-col items-center p-4 rounded-2xl hover:bg-red-50 text-gray-600 hover:text-red-600 transition-colors">
          <span class="material-icons text-2xl mb-2">logout</span>
          <span class="text-xs font-medium">Logout</span>
        </a>
      </div>
    </div>

    <!-- Main Navigation Container -->
    <div class="flex justify-between items-center">
      
      <!-- Home -->
      <a href="{% url 'activities:home' %}" class="nav-hover-effect flex flex-col items-center p-3 rounded-2xl transition-colors {% if request.resolver_match.url_name == 'home' %}bg-indigo-600 text-white shadow-lg{% else %}text-gray-600 hover:bg-gray-100 hover:text-gray-900{% endif %}">
        <span class="material-icons text-2xl mb-1">home</span>
        <span class="text-xs font-medium">Home</span>
      </a>
      
      <!-- Profile -->
      <a href="{% url 'users:profile' user.id %}" class="nav-hover-effect flex flex-col items-center p-3 rounded-2xl transition-colors {% if request.resolver_match.url_name == 'profile' %}bg-indigo-600 text-white shadow-lg{% else %}text-gray-600 hover:bg-gray-100 hover:text-gray-900{% endif %}">
        <span class="material-icons text-2xl mb-1">person_outline</span>
        <span class="text-xs font-medium">Profile</span>
      </a>

      <!-- More Button -->
      <button class="nav-hover-effect flex flex-col items-center p-3 rounded-2xl text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors relative" id="moreButton">
        <!-- Using SVG for consistent sizing and better control -->
        <svg class="more-icon-rotate w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
        <span class="text-xs font-medium">More</span>
      </button>

      <!-- Messages -->
      <a href="{% url 'users:private_messages' %}" class="nav-hover-effect flex flex-col items-center p-3 rounded-2xl transition-colors {% if request.resolver_match.url_name == 'private_messages' %}bg-indigo-600 text-white shadow-lg{% else %}text-gray-600 hover:bg-gray-100 hover:text-gray-900{% endif %}">
        <span class="material-icons text-2xl mb-1">chat_bubble_outline</span>
        <span class="text-xs font-medium">Messages</span>
      </a>

      <!-- Notifications -->
      <a href="#" class="nav-hover-effect flex flex-col items-center p-3 rounded-2xl text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors relative" id="mobile-notifications">
        <span class="material-icons text-2xl mb-1">notifications_none</span>
        <span class="text-xs font-medium">Alerts</span>
        <!-- Notification badge -->
        <span id="mobile-notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold" style="display:none;">0</span>
      </a>
    </div>
  </nav>

  <main class="main-content">
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
      {% block content %}
      <h1 class="text-2xl font-bold text-gray-900 mb-6">Welcome to Bucosa</h1>
      <p class="text-gray-600">Your content goes here...</p>
      {% endblock %}
    </div>
  </main>

  <script>
    // Page Transition Logic
    document.addEventListener('DOMContentLoaded', function() {
      // Hide initial page loader
      const pageLoader = document.getElementById('page-loader');
      setTimeout(() => {
        pageLoader.classList.add('hidden');
      }, 500);

      // Get transition elements
      const pageTransition = document.getElementById('pageTransition');
      const loadingText = document.getElementById('loadingText');
      const navLoadingBar = document.getElementById('nav-loading-bar');
      
      // Function to start loading
      function startLoading(destination) {
        // Show loading transition
        pageTransition.classList.add('active');
        navLoadingBar.classList.add('active');
        
        // Update loading text based on destination
        const pageName = getPageName(destination);
        loadingText.textContent = `Loading ${pageName}...`;
      }
      
      // Function to stop loading
      function stopLoading() {
        pageTransition.classList.remove('active');
        navLoadingBar.classList.remove('active');
      }
      
      // Helper function to get page name from URL
      function getPageName(url) {
        const path = new URL(url, window.location.origin).pathname;
        if (path.includes('profile')) return 'Profile';
        if (path.includes('messages')) return 'Messages';
        if (path.includes('search')) return 'Search';
        if (path.includes('fellowship')) return 'Fellowship';
        if (path.includes('bucosa-main')) return 'Bucosa';
        if (path.includes('home')) return 'Home';
        return 'page';
      }
      
      // Intercept all link clicks
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        
        if (link && link.href && !link.href.includes('#') && 
            !link.classList.contains('no-transition') &&
            new URL(link.href).origin === window.location.origin) {
          e.preventDefault();
          startLoading(link.href);
          
          // Navigate after a short delay to allow animation to show
          setTimeout(() => {
            window.location.href = link.href;
          }, 300);
        }
      });
      
      // When page is fully loaded
      window.addEventListener('load', function() {
        // Hide loading transition with a slight delay
        setTimeout(stopLoading, 300);
      });
      
      // Also hide loading if there's an error
      window.addEventListener('error', stopLoading);

      // Mobile nav toggle logic (existing code)

document.addEventListener('DOMContentLoaded', function() {
  // Mobile nav toggle logic
  const moreButton = document.getElementById('moreButton');
  const expandedMenu = document.getElementById('expandedMenu');
  const closeExpanded = document.getElementById('closeExpanded');
  let isExpanded = false;

  if (moreButton && expandedMenu) {
    const moreIcon = moreButton.querySelector('.more-icon-rotate');
    
    // Toggle expanded menu
    moreButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      isExpanded = !isExpanded;
      
      if (isExpanded) {
        expandedMenu.classList.add('show');
        if (moreIcon) moreIcon.classList.add('active');
        moreButton.classList.add('bg-indigo-100', 'text-indigo-600');
        moreButton.classList.remove('hover:bg-gray-100', 'hover:text-gray-900');
      } else {
        closeExpandedMenu();
      }
    });

    // Close expanded menu
    if (closeExpanded) {
      closeExpanded.addEventListener('click', function(e) {
        e.preventDefault();
        closeExpandedMenu();
      });
    }

    // Close when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#mobileNav') && isExpanded) {
        closeExpandedMenu();
      }
    });

    // Close with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && isExpanded) {
        closeExpandedMenu();
      }
    });

    function closeExpandedMenu() {
      expandedMenu.classList.remove('show');
      if (moreIcon) moreIcon.classList.remove('active');
      moreButton.classList.remove('bg-indigo-100', 'text-indigo-600');
      moreButton.classList.add('hover:bg-gray-100', 'hover:text-gray-900');
      isExpanded = false;
    }
  }

  // Notification handling
  function updateNotificationBadges(count) {
    const badges = document.querySelectorAll('[id$="notification-badge"]');
    badges.forEach(badge => {
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    });
  }

  // Handle notification clicks
  const mobileNotifications = document.getElementById('mobile-notifications');
  const desktopNotifications = document.getElementById('desktop-notifications');
  
  if (mobileNotifications) {
    mobileNotifications.addEventListener('click', function(e) {
      e.preventDefault();
      // Add your notification logic here
      console.log('Mobile notifications clicked');
    });
  }

  if (desktopNotifications) {
    desktopNotifications.addEventListener('click', function(e) {
      e.preventDefault();
      // Add your notification logic here
      console.log('Desktop notifications clicked');
    });
  }

  // Example: Update notification count (uncomment to test)
  // updateNotificationBadges(3);

  // Keep your existing page transition logic here...
  // [Rest of your existing JavaScript for page transitions, loading, etc.]
});
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>