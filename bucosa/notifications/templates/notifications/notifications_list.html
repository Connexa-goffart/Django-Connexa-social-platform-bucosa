{% extends 'base.html' %}
{% block content %}

<div class="max-w-2xl mx-auto w-full px-2 sm:px-0">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
    <h1 class="text-2xl font-bold">Notifications</h1>
    <form id="mark-read-form" method="post" action="{% url 'notifications:mark_notifications_read' %}">
      {% csrf_token %}
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full sm:w-auto">Mark all as read</button>
    </form>
  </div>
  <ul class="divide-y divide-gray-200 bg-white rounded-lg shadow-md overflow-hidden">
    {% for notification in notifications %}
      {% if notification.content_object %}
        <a href="
          {% if notification.content_type.model == 'post' %}
            {% url 'activities:post_detail' notification.object_id %}
          {% elif notification.content_type.model == 'event' %}
            {% url 'activities:event_detail' notification.object_id %}
          {% elif notification.content_type.model == 'privatemessage' %}
            {{ notification.content_object.get_absolute_url }}
          {% else %}#
          {% endif %}"
          class="block focus:outline-none focus:bg-blue-50">
      {% else %}
        <div>
      {% endif %}
      <li class="py-4 px-3 flex items-start gap-3 cursor-pointer hover:bg-gray-50 transition sm:gap-4">
        <span class="material-icons text-2xl sm:text-3xl text-blue-500 flex-shrink-0">
          {% if notification.notification_type == 'like' %}favorite{% elif notification.notification_type == 'comment' %}comment{% elif notification.notification_type == 'follow' %}person_add{% elif notification.notification_type == 'message' %}mail{% else %}notifications{% endif %}
        </span>
        <div class="flex-1 min-w-0">
          <div class="font-medium text-base sm:text-lg text-gray-900 truncate">{{ notification.message|default:notification.notification_type|capfirst }}</div>
          <div class="text-xs sm:text-sm text-gray-500 mt-1">{{ notification.timestamp|date:'M d, Y H:i' }}</div>
        </div>
        {% if not notification.is_read %}
          <span class="ml-auto bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-semibold">New</span>
        {% endif %}
      </li>
      {% if notification.content_object %}
        </a>
      {% else %}
        </div>
      {% endif %}
    {% empty %}
      <li class="py-4 px-3 text-gray-500">No notifications yet.</li>
    {% endfor %}
  </ul>
</div>

<script>
// AJAX mark all as read
document.getElementById('mark-read-form').addEventListener('submit', function(e) {
  e.preventDefault();
  fetch(this.action, {
    method: 'POST',
    headers: {
      'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Requested-With': 'XMLHttpRequest',
    },
    credentials: 'same-origin',
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'ok') {
      document.querySelectorAll('.bg-blue-100').forEach(el => el.style.display = 'none');
    }
  });
});
</script>
{% endblock %}
