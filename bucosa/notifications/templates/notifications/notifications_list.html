{% extends 'base.html' %}
{% block content %}

<!-- Disable body scrolling and enable mobile-like scrolling within container -->
<div class="fixed inset-0 overflow-y-auto bg-gray-50">
  <div class="min-h-full max-w-md mx-auto w-full px-4 py-4">
    <!-- Header with fixed positioning -->
    <div class="sticky top-0 z-10 bg-gray-50 pt-2 pb-3">
      <h1 class="text-2xl font-bold mb-1">Notifications</h1>
      
      <!-- Mark all as read button -->
      <form id="mark-read-form" method="post" action="{% url 'notifications:mark_notifications_read' %}" class="absolute top-3 right-4">
        {% csrf_token %}
        <button type="submit" class="text-blue-600 text-sm font-medium">Mark all as read</button>
      </form>
    </div>

    <!-- Notification content with momentum scrolling -->
    <div class="overflow-y-auto" style="-webkit-overflow-scrolling: touch; height: calc(100vh - 80px)">
      <!-- Unread Section -->
      <div class="mb-6">
        <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Recent</h3>
        
        <!-- Recent Notifications -->
        <div class="space-y-3">
          {% for notification in unread_notifications %}
          {% with sender=notification.sender %}
          <div class="p-3 bg-white rounded-lg">
            {% if notification.notification_type == 'message' %}
              <a href="{% url 'users:private_messages' sender.id %}" class="block font-semibold text-blue-600 hover:underline">
                {% if sender.first_name or sender.last_name %}
                  {{ sender.first_name }} {{ sender.last_name }} sent you a message
                {% else %}
                  {{ sender.email }} sent you a message
                {% endif %}
              </a>
            {% elif notification.notification_type == 'follow' %}
              <span class="font-semibold">{{ sender.first_name }} {{ sender.last_name }} followed you</span>
              {% if request.user != sender %}
                {% if sender.id not in followed_user_ids %}
                  <a href="{% url 'users:follow_user' sender.id %}" class="ml-2 inline-block px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Follow back</a>
                {% else %}
                  <a href="{% url 'users:unfollow_user' sender.id %}" class="ml-2 inline-block px-3 py-1 bg-gray-300 text-gray-700 text-xs rounded hover:bg-gray-400">Unfollow</a>
                {% endif %}
              {% endif %}
            {% elif notification.notification_type == 'like' or notification.notification_type == 'comment' or notification.notification_type == 'share' %}
              <a href="{% url 'activities:post_detail' notification.object_id %}" class="block font-semibold text-blue-600 hover:underline">
                {% if sender.first_name or sender.last_name %}
                  {% if notification.notification_type == 'like' %}
                    {{ sender.first_name }} {{ sender.last_name }} liked your post:
                  {% elif notification.notification_type == 'comment' %}
                    {{ sender.first_name }} {{ sender.last_name }} commented on your post:
                  {% elif notification.notification_type == 'share' %}
                    {{ sender.first_name }} {{ sender.last_name }} shared your post:
                  {% endif %}
                {% else %}
                  {% if notification.notification_type == 'like' %}
                    {{ sender.email }} liked your post:
                  {% elif notification.notification_type == 'comment' %}
                    {{ sender.email }} commented on your post:
                  {% elif notification.notification_type == 'share' %}
                    {{ sender.email }} shared your post:
                  {% endif %}
                {% endif %}
              </a>
            {% else %}
              <span class="font-semibold">
                {% if sender.first_name or sender.last_name %}
                  {{ sender.first_name }} {{ sender.last_name }} sent a notification
                {% else %}
                  {{ sender.email }} sent a notification
                {% endif %}
              </span>
            {% endif %}
            {% if notification.content_object and notification.content_object.content %}
              <div class="text-gray-600 mt-1 text-sm">{{ notification.content_object.content|truncatechars:50 }}</div>
            {% endif %}
            <div class="text-xs text-gray-400 mt-2">{{ notification.timestamp|timesince }} ago</div>
          </div>
          {% endwith %}
          {% endfor %}
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-200 my-3"></div>

      <!-- Earlier Section -->
      <div class="mb-6">
        <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Earlier</h3>
        
        <!-- Earlier Notifications -->
        <div class="space-y-3">
          {% for notification in read_notifications %}
          {% with sender=notification.sender %}
          <div class="p-3 bg-white rounded-lg">
            {% if notification.notification_type == 'message' %}
              <a href="{% url 'users:private_messages' sender.id %}" class="block font-semibold text-blue-600 hover:underline">
            {% elif notification.notification_type == 'follow' %}
              <span class="font-semibold">{{ sender.first_name }} {{ sender.last_name }} followed you</span>
              {% if request.user != sender %}
                {% if not request.user.following.filter(following_user=sender).exists %}
                  <a href="{% url 'users:follow_user' sender.id %}" class="ml-2 inline-block px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Follow back</a>
                {% else %}
                  <a href="{% url 'users:unfollow_user' sender.id %}" class="ml-2 inline-block px-3 py-1 bg-gray-300 text-gray-700 text-xs rounded hover:bg-gray-400">Unfollow</a>
                {% endif %}
              {% endif %}
            {% else %}
              <span class="font-semibold">
                {% if sender.first_name or sender.last_name %}
                  {% if notification.notification_type == 'like' %}
                    {{ sender.first_name }} {{ sender.last_name }} liked your post:
                  {% elif notification.notification_type == 'comment' %}
                    {{ sender.first_name }} {{ sender.last_name }} commented on your post:
                  {% elif notification.notification_type == 'message' %}
                    {{ sender.first_name }} {{ sender.last_name }} sent you a message
                  {% else %}
                    {{ sender.first_name }} {{ sender.last_name }} sent a notification
                  {% endif %}
                {% else %}
                  {% if notification.notification_type == 'like' %}
                    {{ sender.email }} liked your post:
                  {% elif notification.notification_type == 'comment' %}
                    {{ sender.email }} commented on your post:
                  {% elif notification.notification_type == 'message' %}
                    {{ sender.email }} sent you a message
                  {% else %}
                    {{ sender.email }} sent a notification
                  {% endif %}
                {% endif %}
              </span>
            {% endif %}
            {% if notification.content_object and notification.content_object.content %}
            <div class="text-gray-600 mt-1 text-sm">{{ notification.content_object.content|truncatechars:50 }}</div>
            {% endif %}
            <div class="text-xs text-gray-400 mt-2">{{ notification.timestamp|timesince }} ago</div>
          </div>
          {% endwith %}
          {% empty %}
          <div class="text-center text-gray-500 py-4 text-sm">No earlier notifications</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* iOS-style momentum scrolling */
  .overflow-y-auto {
    -webkit-overflow-scrolling: touch;
  }
  /* Disable body scroll */
  body {
    overflow: hidden;
  }
</style>

<script>
  // Prevent default body scrolling
  document.body.style.overflow = 'hidden';
  
  // AJAX mark all as read
  document.getElementById('mark-read-form').addEventListener('submit', function(e) {
    e.preventDefault();
    fetch(this.action, {
      method: 'POST',
      headers: {
        'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest',
      },
      credentials: 'same-origin',
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'ok') {
        // Optionally update UI to show notifications as read
        window.location.reload();
      }
    });
  });
</script>

{% endblock %}