{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="min-h-screen w-full flex bg-black text-white">
  <!-- Center Feed -->
  <main class="flex flex-col items-center flex-1 min-h-screen bg-black px-0 py-1 border-x border-gray-800">
    {% if posts %}
    <div class="flex flex-col gap-4 mt-2 w-full max-w-2xl px-4">
      {% for post in posts %}
      <div class="bg-[#16181c] rounded-2xl shadow-xl p-4 w-full border border-gray-800">
        {% if post.repost_of %}
        <!-- Repost Banner -->
        <div class="text-xs text-gray-500 italic mb-2 flex items-center gap-1">
          <span class="material-icons text-sm text-orange-400">repeat</span>
          Reposted from
          <a href="{% url 'users:profile' post.repost_of.author.id %}" class="underline">@{{ post.repost_of.author.username }}</a>
        </div>
        <!-- Reposted Content -->
        <div class="bg-[#1e1f23] border border-gray-700 rounded-xl p-3 mb-3">
          <div class="text-sm text-gray-300">
            {% if post.repost_of.content %}{{ post.repost_of.content }}{% endif %}
          </div>
          {% if post.repost_of.image %}
          <img src="{{ post.repost_of.image.url }}" alt="Reposted Image" loading="lazy" class="rounded-xl w-full aspect-video object-cover border border-gray-700 shadow my-2">
          {% endif %}
          {% if post.repost_of.video %}
          <video controls class="rounded-xl w-full aspect-video object-cover border border-gray-700 shadow my-2">
            <source src="{{ post.repost_of.video.url }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          {% endif %}
        </div>
        {% endif %}

        <!-- Author Info -->
        <div class="flex items-center gap-3 mb-2">
          <a href="{% url 'users:profile' post.author.id %}" aria-label="Author profile">
            <img src="{{ post.author.profile.profile_image.url|default:'{% static 'images/default.jpg' %}' }}" alt="{{ post.author.username }}" class="w-10 h-10 rounded-full object-cover">
          </a>
          <div>
            <a href="{% url 'users:profile' post.author.id %}" class="font-bold text-gray-200 hover:underline">@{{ post.author.username }}</a>
            <div class="text-xs text-gray-500">
              {{ post.created_at|timesince }} ago
              {% if post.group %}
              ¬∑ Group: <a href="{% url 'users:group_profile' post.group.id %}" class="hover:underline">{{ post.group.name }}</a>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Text Content -->
        {% if post.content %}
        <div class="text-gray-300 text-sm mb-3">{{ post.content }}</div>
        {% endif %}

        <!-- Media -->
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post Image" loading="lazy" class="rounded-xl w-full aspect-video object-cover border border-gray-700 shadow mb-3">
        {% endif %}
        {% if post.video %}
        <video controls class="rounded-xl w-full aspect-video object-cover border border-gray-700 shadow mb-3">
          <source src="{{ post.video.url }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        {% endif %}

        <!-- Actions -->
        <div class="flex justify-between items-center mt-3 text-gray-400 text-sm border-t border-gray-800 pt-3">
          <form action="{% url 'activities:like_post' post.id %}" method="post" class="flex-1 text-center">
            {% csrf_token %}
            <button aria-label="Like post" type="submit" class="hover:text-red-500">‚ù§Ô∏è {{ post.likes.count }}</button>
          </form>

          <form action="{% url 'activities:save_post' post.id %}" method="post" class="flex-1 text-center">
            {% csrf_token %}
            <button aria-label="Save post" type="submit" class="hover:text-green-500">üìå {{ post.saves.count }}</button>
          </form>

          <a href="{% url 'activities:share_page' post.id %}" aria-label="Share post" class="flex-1 text-center hover:text-blue-400">üîó</a>

          {% if not post.repost_of or post.repost_of.author != user %}
          <form action="{% url 'activities:repost_post' post.id %}" method="post" class="flex-1 text-center">
            {% csrf_token %}
            <button aria-label="Repost" type="submit" class="hover:text-orange-500">üîÅ {{ post.repost_count }}</button>
          </form>
          {% endif %}

          <button type="button" aria-label="Toggle comments" class="flex-1 text-center toggle-comments-btn hover:text-gray-200" data-post-id="{{ post.id }}">üí¨ {{ post.comments.count }}</button>
        </div>

        <!-- Comments -->
        <div class="comments-section hidden mt-4" id="comments-section-{{ post.id }}">
          <div class="bg-gray-900 rounded-xl p-4">
            <ul class="space-y-3">
              {% for comment in post.comments.all %}
              <li class="flex items-start gap-3 bg-black rounded-lg p-3 shadow-sm">
                <a href="{% url 'users:profile' comment.author.id %}">
                  <img src="{{ comment.author.profile.profile_image.url|default:'{% static 'images/default.jpg' %}' }}" alt="{{ comment.author.username }}" class="w-9 h-9 rounded-full object-cover mt-1">
                </a>
                <div>
                  <div class="flex items-center gap-2">
                    <a href="{% url 'users:profile' comment.author.id %}" class="font-semibold text-white hover:underline">{{ comment.author.username }}</a>
                    <span class="text-xs text-gray-400">¬∑ {{ comment.created_at|timesince }} ago</span>
                  </div>
                  <div class="text-gray-300 text-sm mt-1">{{ comment.content }}</div>
                </div>
              </li>
              {% empty %}
              <li class="text-gray-500 text-sm text-center">No comments yet.</li>
              {% endfor %}
            </ul>

            {% if user.is_authenticated %}
            <form action="{% url 'activities:add_comment' post.id %}" method="post" class="mt-4 flex gap-2 items-start">
              {% csrf_token %}
              <img src="{{ user.profile.profile_image.url|default:'{% static 'images/default.jpg' %}' }}" alt="Your Profile" class="w-9 h-9 rounded-full object-cover mt-1">
              <textarea name="content" rows="1" required placeholder="Add a comment..." class="flex-1 resize-none border border-gray-800 rounded-lg px-3 py-2 text-white bg-black focus:outline-none focus:ring-2 focus:ring-gray-700"></textarea>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg shadow">Post</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-gray-500 text-lg py-10">No posts to show. Start following people or join groups to see more!</div>
    {% endif %}
  </main>

  <!-- Sidebar -->
  <aside class="hidden xl:block xl:w-[320px] 2xl:w-[350px] px-4 py-6 border-l border-gray-800 bg-black sticky top-0 h-screen overflow-y-auto">
    <!-- Sidebar content remains unchanged -->
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.toggle-comments-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const section = document.getElementById('comments-section-' + btn.dataset.postId);
      section.classList.toggle('hidden');
    });
  });
});
</script>
{% endblock content %}