{% extends 'base.html' %}
{% load static %}
{% load user_extras %}
{% block content %}
<script>
// AJAX for Like, Save, Share, and Comment
document.addEventListener('DOMContentLoaded', function() {
    function ajaxForm(formId, countSelector, btnSelector, successText) {
        const form = document.getElementById(formId);
        if (!form) return;
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const xhr = new XMLHttpRequest();
            xhr.open('POST', form.action);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (countSelector && data.count !== undefined) {
                        document.querySelector(countSelector).textContent = data.count + ' ' + successText + (data.count === 1 ? '' : 's');
                    }
                    if (btnSelector && data.liked !== undefined) {
                        const btn = document.querySelector(btnSelector);
                        btn.textContent = data.liked ? 'Unlike' : 'Like';
                    }
                    if (btnSelector && data.saved !== undefined) {
                        const btn = document.querySelector(btnSelector);
                        btn.textContent = data.saved ? 'Unsave' : 'Save';
                    }
                    if (btnSelector && data.shared !== undefined) {
                        const btn = document.querySelector(btnSelector);
                        btn.textContent = 'Shared!';
                        setTimeout(() => { btn.textContent = 'Share'; }, 1500);
                    }
                }
                if (formId === 'comment-box' && xhr.status === 200) {
                    // Reload comments section
                    window.location.reload();
                }
            };
            const formData = new FormData(form);
            xhr.send(formData);
        });
    }
    ajaxForm('like-form', '.like-count', '.like-btn', 'Like');
    ajaxForm('save-form', null, '.save-btn', 'Save');
    ajaxForm('share-form', null, '.share-btn', 'Share');
    ajaxForm('comment-box', null, null, '');
});
</script>
<div class="max-w-xl mx-auto bg-white rounded-xl shadow mt-6">
    <!-- Author and time -->
    <div class="flex items-center gap-3 px-5 pt-5">
        {% if post.author.profile and post.author.profile.profile_image %}
            <img src="{{ post.author.profile.profile_image.url }}" alt="{{ post.author.username }}'s Profile" class="w-12 h-12 rounded-full object-cover">
        {% else %}
            <img src="{% static 'images/default.jpg' %}" alt="Default Profile" class="w-12 h-12 rounded-full object-cover">
        {% endif %}
        <div>
            <div class="font-semibold text-gray-900">{{ post.author.get_full_name|default:post.author.username }}</div>
            <div class="text-xs text-gray-500">{{ post.created_at|timesince }} ago</div>
        </div>
    </div>
    <!-- Content -->
    <div class="px-5 py-3 text-base text-gray-900">{{ post.content }}</div>
    {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post Image" class="w-full rounded-xl mb-2 max-h-96 object-cover">
    {% endif %}
    {% if post.video %}
        <video controls class="w-full rounded-xl mb-2 max-h-96">
            <source src="{{ post.video.url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% endif %}

    <!-- Reactions summary -->
    <div class="flex items-center justify-between px-5 py-2 border-b border-gray-100">
        <div class="flex items-center gap-1">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-4 h-4"><path d="M2 10a6 6 0 1112 0A6 6 0 012 10zm6-4a4 4 0 100 8 4 4 0 000-8z"/></svg>
            </span>
                                <span class="like-count text-sm text-gray-700">{{ post.likes.count }} Like{{ post.likes.count|pluralize }}</span>
            <span class="ml-3 text-sm text-gray-700">{{ post.comments.count }} Comment{{ post.comments.count|pluralize }}</span>
            <span class="ml-3 text-sm text-gray-700">{{ post.shares.count }} Share{{ post.shares.count|pluralize }}</span>
        </div>
    </div>

    <!-- Like avatars -->
    {% if post.likes.count > 0 %}
    <div class="flex items-center px-5 py-2 -mt-2">
        {% for like in post.likes.all|slice:":6" %}
            {% with liker=like.user %}
                {% if liker.profile and liker.profile.profile_image %}
                    <img src="{{ liker.profile.profile_image.url }}" alt="{{ liker.username }}" class="w-7 h-7 rounded-full border-2 border-white -ml-2 first:ml-0">
                {% else %}
                    <img src="{% static 'images/default.jpg' %}" alt="Default" class="w-7 h-7 rounded-full border-2 border-white -ml-2 first:ml-0">
                {% endif %}
            {% endwith %}
        {% endfor %}
        {% if post.likes.count > 6 %}
            <span class="ml-2 text-xs text-gray-500">+{{ post.likes.count|add:"-6" }} more</span>
        {% endif %}
    </div>
    {% endif %}

        <!-- Facebook-style actions (functional) -->
        <div class="flex justify-around border-t border-b border-gray-100 py-2 bg-gray-50">
            <form id="like-form" method="post" action="{% url 'activities:like_post' post.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="flex items-center gap-1 px-4 py-2 rounded hover:bg-blue-50 text-blue-600 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" class="w-5 h-5"><path d="M2 10a6 6 0 1112 0A6 6 0 012 10zm6-4a4 4 0 100 8 4 4 0 000-8z"/></svg>
                    Like
                </button>
            </form>
            <a href="#comment-box" class="flex items-center gap-1 px-4 py-2 rounded hover:bg-blue-50 text-gray-700 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8a9 9 0 1118 0z"/></svg>
                Comment
            </a>
            <form id="share-form" method="post" action="{% url 'activities:share_post' post.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="flex items-center gap-1 px-4 py-2 rounded hover:bg-blue-50 text-gray-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    Share
                </button>
            </form>
            <form id="save-form" method="post" action="{% url 'activities:save_post' post.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="flex items-center gap-1 px-4 py-2 rounded hover:bg-blue-50 text-gray-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Save
                </button>
            </form>
        </div>

    <!-- Highlight reaction if coming from notification -->
    {% if reaction == 'like' %}
        <div class="mt-4 p-3 bg-green-100 border border-green-300 rounded flex items-center gap-2 mx-5">
            <span class="text-green-700 font-semibold">This post was liked!</span>
            <span class="text-xs text-gray-500">(from your notification)</span>
        </div>
    {% elif reaction == 'save' %}
        <div class="mt-4 p-3 bg-blue-100 border border-blue-300 rounded flex items-center gap-2 mx-5">
            <span class="text-blue-700 font-semibold">This post was saved!</span>
            <span class="text-xs text-gray-500">(from your notification)</span>
        </div>
    {% elif reaction == 'share' %}
        <div class="mt-4 p-3 bg-purple-100 border border-purple-300 rounded flex items-center gap-2 mx-5">
            <span class="text-purple-700 font-semibold">This post was shared!</span>
            <span class="text-xs text-gray-500">(from your notification)</span>
        </div>
    {% elif reaction == 'comment' and comment_id %}
        <div class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded flex items-center gap-2 mx-5">
            <span class="text-yellow-700 font-semibold">This post was commented on!</span>
            <span class="text-xs text-gray-500">(from your notification)</span>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var commentElem = document.getElementById('comment-{{ comment_id }}');
                if (commentElem) {
                    commentElem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    commentElem.classList.add('ring-2', 'ring-yellow-400');
                }
            });
        </script>
    {% endif %}

    <!-- Comments -->
    <div class="px-5 pt-4 pb-2">
        <div class="font-semibold text-gray-800 mb-2">Comments</div>
        <div class="space-y-3">
            {% for comment in comments %}
                <div id="comment-{{ comment.id }}" class="p-3 bg-gray-50 rounded border border-gray-200">
                    <div class="flex items-center gap-2 mb-1">
                        {% if comment.author.profile and comment.author.profile.profile_image %}
                            <img src="{{ comment.author.profile.profile_image.url }}" alt="{{ comment.author.username }}'s Profile" class="w-7 h-7 rounded-full object-cover">
                        {% else %}
                            <img src="{% static 'images/default.jpg' %}" alt="Default Profile" class="w-7 h-7 rounded-full object-cover">
                        {% endif %}
                        <span class="font-semibold text-sm">{{ comment.author.get_full_name|default:comment.author.username }}</span>
                        <span class="text-xs text-gray-400 ml-2">{{ comment.created_at|timesince }} ago</span>
                    </div>
                    <div class="text-sm">{{ comment.content }}</div>
                </div>
            {% endfor %}
        </div>
            <!-- Facebook-style comment box (functional) -->
            <form id="comment-box" method="post" action="{% url 'activities:add_comment' post.id %}" class="flex items-center gap-2 mt-4">
                {% csrf_token %}
                {% if user.is_authenticated and user.profile and user.profile.profile_image %}
                    <img src="{{ user.profile.profile_image.url }}" alt="{{ user.username }}" class="w-8 h-8 rounded-full object-cover">
                {% else %}
                    <img src="{% static 'images/default.jpg' %}" alt="Default" class="w-8 h-8 rounded-full object-cover">
                {% endif %}
                <input name="content" type="text" class="flex-1 rounded-full border border-gray-200 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Write a comment..." required>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-semibold">Post</button>
            </form>
    </div>
</div>
{% endblock %}
