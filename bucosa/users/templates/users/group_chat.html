{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="bg-white rounded-2xl shadow-lg p-6 max-w-2xl mx-auto">
  <h3 class="text-xl font-bold mb-4 text-gray-800">Group Chat: {{ group.name }}</h3>
  <div class="space-y-6">
    {% for msg in messages %}
      <div class="flex items-start gap-3 {% if msg.user == request.user %}justify-end{% endif %}">
        {% if msg.user.profile and msg.user.profile.profile_image %}
          <a href="{% url 'users:profile' msg.user.id %}">
            <img src="{{ msg.user.profile.profile_image.url }}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-200 shadow" alt="{{ msg.user.username }}">
          </a>
        {% else %}
          <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xl font-bold">{{ msg.user.username|first }}</div>
        {% endif %}
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-800">{{ msg.user.username }}</span>
            <span class="text-xs text-gray-400">({{ msg.timestamp|timesince }} ago)</span>
          </div>
          <div class="inline-block bg-gray-100 rounded-xl px-5 py-3 mt-1 shadow-sm max-w-lg">
            <div class="text-gray-900 text-base">{{ msg.content|linebreaksbr }}</div>
            {% if msg.file %}
              {% with msg.file.url|lower as file_url %}
                {% if file_url|slice:'-4:' == '.jpg' or file_url|slice:'-5:' == '.jpeg' or file_url|slice:'-4:' == '.png' or file_url|slice:'-4:' == '.gif' %}
                  <img src="{{ msg.file.url }}" class="rounded-lg mt-2 max-w-xs border border-gray-200 shadow" />
                {% elif file_url|slice:'-4:' == '.mp4' or file_url|slice:'-5:' == '.webm' or file_url|slice:'-4:' == '.ogg' %}
                  <video controls class="rounded-lg mt-2 max-w-xs border border-gray-200 shadow">
                    <source src="{{ msg.file.url }}">
                  </video>
                {% else %}
                  <a href="{{ msg.file.url }}" target="_blank" class="text-blue-500 underline block mt-2">Download file</a>
                {% endif %}
              {% endwith %}
            {% endif %}
          </div>
          <div class="flex items-center gap-2 mt-2 text-sm">
            {% for emoji, count in msg.reaction_tuples %}
              <form action="{% url 'users:react_to_message' msg.id emoji %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="bg-white border border-gray-300 rounded-full px-2 py-1 hover:bg-blue-50 transition text-base mr-1 {% if msg.user_reaction == emoji %}font-bold text-blue-600{% endif %}">
                  {{ emoji }} <span class="ml-1 text-gray-500">{{ count }}</span>
                </button>
              </form>
            {% endfor %}
            {% if request.user == msg.group.profile.creator %}
              <a href="{% url 'users:pin_message' msg.id %}" class="ml-2 text-gray-500 hover:text-blue-600 cursor-pointer text-xs">Pin</a>
            {% endif %}
            {% if request.user == msg.user %}
              <a href="{% url 'users:edit_group_message' msg.id %}" class="ml-2 text-yellow-600 hover:underline cursor-pointer text-xs">Edit</a>
              <form action="{% url 'users:delete_group_message' msg.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="ml-2 text-red-500 hover:underline cursor-pointer text-xs bg-transparent border-none">Delete</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <form method="post" enctype="multipart/form-data" class="mt-6">
    {% csrf_token %}
    <textarea name="content" rows="2" class="w-full border rounded-xl p-3 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Type your message..."></textarea>
    <div class="flex flex-col md:flex-row md:items-center gap-3 mb-2">
      <label for="group-file-input" class="flex items-center cursor-pointer bg-gray-100 border border-gray-300 rounded px-3 py-2 hover:bg-blue-50 transition">
        <span class="material-icons text-green-500 mr-2">attach_file</span>
        <span class="text-sm text-gray-700">Attach File (PDF, DOCX, ZIP, etc)</span>
        <input id="group-file-input" type="file" name="file" class="hidden">
      </label>
    </div>
    <button type="submit" class="mt-2 bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition font-bold shadow">Send</button>
  </form>
  <a href="{% url 'users:group_profile' group.id %}" class="inline-block mt-4 text-blue-600 hover:underline">Back to Group</a>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var groupId = {{ group.id }};
    var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    var socket = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/messages/group/' + groupId + '/');
    var notificationSocket = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/notifications/');

    socket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var chatDiv = document.querySelector('.space-y-6');
        if (chatDiv) {
            var msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3';
            msgDiv.innerHTML = `<div class=\"flex-1\"><div class=\"flex items-center gap-2\"><span class=\"font-bold text-gray-800\">${data.sender}</span><span class=\"text-xs text-gray-400\">(now)</span></div><div class=\"inline-block bg-gray-100 rounded-xl px-5 py-3 mt-1 shadow-sm max-w-lg\"><div class=\"text-gray-900 text-base\">${data.content}</div></div></div>`;
            chatDiv.appendChild(msgDiv);
            // Scroll into view
            msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    };

    // Listen for notifications and show a toast for new group message notifications
    notificationSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.notification_type === 'message') {
            showToast('New group message: ' + data.message);
            // Optionally, auto-mark as read (AJAX call)
            markGroupMessagesAsRead();
        }
    };

    function showToast(msg) {
        var toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.position = 'fixed';
        toast.style.bottom = '30px';
        toast.style.right = '30px';
        toast.style.background = '#2563eb';
        toast.style.color = 'white';
        toast.style.padding = '16px 24px';
        toast.style.borderRadius = '8px';
        toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
        toast.style.zIndex = 9999;
        document.body.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3500);
    }

    function markGroupMessagesAsRead() {
        var groupId = {{ group.id }};
        fetch(`/users/mark_group_messages_read/${groupId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
    }
});
</script>
{% endblock %}
